name: Deploy to Cloudflare Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Verify Node.js version
        run: node --version && npm --version
      
      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
      
      - name: Build project
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Verify build output
        run: |
          if [ ! -d "dist" ]; then
            echo "‚ùå Error: dist directory not found after build"
            exit 1
          fi
          echo "‚úÖ Build output verified"
          ls -la dist/ | head -20
      
      - name: Check Cloudflare secrets
        run: |
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "‚ùå Error: CLOUDFLARE_API_TOKEN secret is not set"
            echo "üìã Please set it at: https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          fi
          if [ -z "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" ]; then
            echo "‚ùå Error: CLOUDFLARE_ACCOUNT_ID secret is not set"
            echo "üìã Please set it at: https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          fi
          echo "‚úÖ Cloudflare secrets are configured"
      
      - name: Verify dist directory contents
        run: |
          echo "üì¶ Checking dist directory..."
          ls -la dist/
          echo ""
          echo "üìä Directory size:"
          du -sh dist/
          echo ""
          echo "üìÅ Key files check:"
          [ -f "dist/index.html" ] && echo "‚úÖ index.html exists" || echo "‚ùå index.html missing"
          [ -d "dist/static" ] && echo "‚úÖ static/ directory exists" || echo "‚ùå static/ directory missing"
          [ -d "dist/functions" ] && echo "‚úÖ functions/ directory exists" || echo "‚ö†Ô∏è  functions/ directory missing (optional)"
      
      - name: Test wrangler command
        run: |
          echo "üß™ Testing wrangler installation..."
          npx wrangler --version
          echo ""
          echo "üß™ Testing wrangler pages command..."
          npx wrangler pages project list --account-id=${{ secrets.CLOUDFLARE_ACCOUNT_ID }} || echo "‚ö†Ô∏è  Cannot list projects (may need auth)"
      
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=nexx-gsm --compatibility-date=2026-01-21
          workingDirectory: .
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      
      - name: Check deployment status
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "üìã Troubleshooting steps:"
          echo "1. Check Cloudflare API token permissions"
          echo "2. Verify account ID is correct"
          echo "3. Check if project 'nexx' exists in Cloudflare Pages"
          echo "4. Review wrangler logs above for specific errors"
