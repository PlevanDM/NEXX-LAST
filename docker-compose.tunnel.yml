version: '3.8'

services:
  # Production версия с туннелем
  nexx-prod:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nexx-prod
    ports:
      - "3000:3000"
    restart: unless-stopped
    environment:
      - NODE_ENV=production
    networks:
      - nexx-network

  # Cloudflare Tunnel (cloudflared)
  cloudflare-tunnel:
    image: cloudflare/cloudflared:latest
    container_name: nexx-tunnel
    command: tunnel --no-autoupdate run
    environment:
      - TUNNEL_TOKEN=${TUNNEL_TOKEN:-}
    depends_on:
      - nexx-prod
    restart: unless-stopped
    networks:
      - nexx-network

  # Альтернатива: ngrok туннель
  ngrok:
    image: ngrok/ngrok:latest
    container_name: nexx-ngrok
    command: http nexx-prod:3000 --authtoken=${NGROK_AUTH_TOKEN:-}
    depends_on:
      - nexx-prod
    restart: unless-stopped
    networks:
      - nexx-network
    profiles:
      - ngrok  # Запускается только с --profile ngrok

networks:
  nexx-network:
    driver: bridge
