# Личный кабинет (Personal Cabinet) — план и туду-лист

## Цель
Дать пользователям возможность входить по номеру телефона и видеть список своих заказов из Remonline (мои заказы, статусы).

---

## Этап 1: Бэкенд и Remonline API

- [x] **1.1** Добавить в `Bindings` переменные: `CABINET_JWT_SECRET` (опционально, fallback — REMONLINE_API_KEY).
- [x] **1.2** Реализовать получение Remonline token (общая функция/повтор использования существующей логики).
- [x] **1.3** Реализовать поиск клиента по телефону: `GET /clients/?token=...&phones[]=...` → `client_id`.
- [x] **1.4** Реализовать получение заказов по клиенту:
  - Попробовать `GET /order/?token=...&client_id=...` (или `clients[]=...` — по документации Remonline).
  - Если API отдаёт все заказы — запрашивать список и фильтровать по `client_id` на нашей стороне.
- [x] **1.5** Эндпоинт входа: `POST /api/cabinet/login` — тело `{ phone }`:
  - Нормализация телефона (как в существующих формах).
  - Поиск клиента в Remonline по телефону.
  - Если клиент найден — выдать JWT с полями `client_id`, `phone`, `exp` (например, 7 дней).
  - Ответ: `{ success, token, client_id }` или ошибка.
- [x] **1.6** Эндпоинт списка заказов: `GET /api/cabinet/orders`:
  - Заголовок `Authorization: Bearer <token>` или cookie с токеном.
  - Проверка JWT, извлечение `client_id`.
  - Запрос к Remonline — заказы по `client_id`.
  - Ответ: `{ success, data: orders[] }`.
- [x] **1.7** Эндпоинт выхода: `POST /api/cabinet/logout` — инвалидация на клиенте (удалить токен/cookie); при необходимости черный список токенов не делаем в MVP.

---

## Этап 2: Фронтенд — маршрутизация и страницы

- [x] **2.1** Обеспечить загрузку одного и того же SPA для `/cabinet`:
  - В `_redirects`: `/cabinet / 200` (отдавать `index.html` для `/cabinet`).
- [x] **2.2** В точке входа лендинга (например, `landing-client.tsx` или `LandingApp`) проверять `window.location.pathname`:
  - Если `pathname === '/cabinet'` — рендерить компонент кабинета (Cabinet), иначе — текущий лендинг.
- [x] **2.3** Компонент кабинета (например, `Cabinet.tsx` или `CabinetApp.tsx`):
  - При отсутствии токена — показывать форму входа (телефон, кнопка «Войти»).
  - После успешного входа — сохранять токен (localStorage или cookie, как решено) и показывать «Мои заказы».
  - Список заказов: номер, статус, дата (по данным Remonline); при необходимости — ссылка «Подробнее» / детали одного заказа.
  - Кнопка «Выйти» — очистка токена и переход на экран входа.
- [x] **2.4** Добавить в хедер/футер ссылку «Личный кабинет» / «Мои заказы» на `/cabinet`.

---

## Этап 3: Безопасность и UX

- [ ] **3.1** Ограничить частоту запросов на `POST /api/cabinet/login` (rate limit), чтобы снизить риск перебора номеров.
- [ ] **3.2** (Опционально) Подтверждение по SMS: после ввода телефона отправлять код, входить только после правильного кода (требует интеграции SMS-шлюза).
- [ ] **3.3** В JWT не хранить чувствительных данных, только `client_id`, `phone`, `iat`, `exp`.
- [x] **3.4** Токен хранить в `localStorage` или в httpOnly cookie (если выбран cookie — настроить `POST /api/cabinet/login` на установку cookie и проверку в `GET /api/cabinet/orders`).

---

## Этап 4: Локализация и контент

- [x] **4.1** Добавить ключи переводов для кабинета (например, в `public/static/i18n.js` или там, где хранятся переводы лендинга):
  - cabinet.title, cabinet.login, cabinet.phonePlaceholder, cabinet.submit, cabinet.myOrders, cabinet.orderNumber, cabinet.status, cabinet.date, cabinet.logout, cabinet.notFound, cabinet.error, cabinet.loginSuccess.
- [x] **4.2** Поддержать языки: RO, UA, RU, EN (как на остальном сайте).

---

## Этап 5: Документация и деплой

- [x] **5.1** Описать в проекте: см. `CABINET-SETUP.md` (env: `REMONLINE_API_KEY`, опционально `CABINET_JWT_SECRET`; вход и список заказов; проверка Remonline API).
- [ ] **5.2** В Cloudflare Pages добавить переменные окружения (если используется отдельный секрет для JWT).
- [ ] **5.3** После деплоя: проверить вход по телефону и отображение «Мои заказы».

---

## Зависимости от Remonline

- **Получение заказов по client_id:** точный формат запроса нужно уточнить по документации Remonline (например, `client_id`, `clients[]`, или фильтр). В коде реализован вариант с параметром `client_id` и запасной вариант — запрос списка заказов с фильтрацией по `client_id` на нашей стороне.
- **Формат ответа заказов:** поля `id`, `status_id`, `created_at`, `client_id` и т.д. — использовать для отображения в списке и деталях.

---

## Чек-лист перед релизом

- [ ] Вход по телефону работает для номера, по которому есть клиент в Remonline.
- [ ] Список заказов показывает только заказы этого клиента.
- [ ] Неавторизованный пользователь не видит заказы (редирект на экран входа или 401).
- [ ] Ссылка «Личный кабинет» видна в навигации.
- [ ] Переводы для всех целевых языков добавлены.
- [ ] Rate limit на логин включён (по возможности).
